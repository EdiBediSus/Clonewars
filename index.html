<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLONE WAR â€” Battle Simulation</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

*{margin:0;padding:0;box-sizing:border-box;}
body{background:#87ceeb;color:#1a1a2e;font-family:'Share Tech Mono',monospace;overflow:hidden;height:100vh;user-select:none;}
canvas{display:block;}

/* â”€â”€ HUD â”€â”€ */
#hud{position:absolute;inset:0;pointer-events:none;z-index:10;}

/* top bar */
#title-bar{
  position:absolute;top:0;left:0;right:0;
  padding:14px 22px 18px;
  background:linear-gradient(180deg,rgba(10,12,30,0.82) 0%,rgba(10,12,30,0.0) 100%);
  display:flex;align-items:flex-start;justify-content:space-between;
}
.army-panel{display:flex;flex-direction:column;gap:6px;min-width:220px;}
.army-name{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:900;letter-spacing:3px;display:flex;align-items:center;gap:8px;}
.army-panel.left .army-name{color:#4dc3ff;}
.army-panel.right .army-name{color:#ff6644;justify-content:flex-end;}
.army-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.army-panel.left  .army-dot{background:#4dc3ff;box-shadow:0 0 8px #4dc3ff;}
.army-panel.right .army-dot{background:#ff6644;box-shadow:0 0 8px #ff6644;}
.stat-row{display:flex;gap:14px;font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:1px;}
.army-panel.right .stat-row{justify-content:flex-end;}
.sv{color:rgba(255,255,255,0.9);font-size:10px;}
.hbar-wrap{height:4px;background:rgba(255,255,255,0.12);border-radius:2px;overflow:hidden;position:relative;}
.army-panel.left  .hbar-wrap{width:220px;}
.army-panel.right .hbar-wrap{width:220px;margin-left:auto;}
.hbar{height:100%;border-radius:2px;transition:width 0.5s ease;}
.army-panel.left  .hbar{background:linear-gradient(90deg,#1a88ff,#44ddff);}
.army-panel.right .hbar{background:linear-gradient(90deg,#ff3300,#ff8844);float:right;}

/* kill badges */
.kill-badge{font-size:10px;font-weight:700;padding:1px 8px;border-radius:1px;letter-spacing:1px;}
.army-panel.left  .kill-badge{background:rgba(77,195,255,0.15);color:#4dc3ff;border-left:2px solid #4dc3ff;}
.army-panel.right .kill-badge{background:rgba(255,102,68,0.15);color:#ff6644;border-right:2px solid #ff6644;text-align:right;}

/* center */
#center-hud{text-align:center;padding-top:2px;}
#game-title{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;letter-spacing:8px;color:#fff;text-shadow:0 2px 20px rgba(0,0,0,0.5);}
#phase-tag{
  display:inline-block;margin-top:5px;padding:2px 12px;
  font-size:8px;letter-spacing:4px;text-transform:uppercase;
  border-radius:1px;font-family:'Orbitron',sans-serif;
  background:rgba(255,200,0,0.15);color:#ffd700;border:1px solid rgba(255,200,0,0.3);
}

/* bottom-left log */
#battle-log{position:absolute;bottom:76px;left:18px;width:280px;pointer-events:none;}
.log-entry{
  font-size:9px;line-height:1.9;color:rgba(255,255,255,0.45);
  display:flex;align-items:center;gap:6px;
}
.log-entry::before{content:'â€º';font-size:11px;}
.log-entry.blue{color:#4dc3ff;}
.log-entry.red{color:#ff7755;}
.log-entry.system{color:#ffd700;}
.log-entry.good{color:#44ee88;}

/* bottom-right stats */
#mini-stats{position:absolute;bottom:76px;right:18px;text-align:right;font-size:9px;color:rgba(255,255,255,0.35);line-height:2.1;letter-spacing:1px;}
#stat-fps{color:rgba(255,255,255,0.5);}

/* cam hint */
#cam-hint{
  position:absolute;top:64px;left:50%;transform:translateX(-50%);
  font-size:8px;letter-spacing:2px;color:rgba(255,255,255,0.4);
  background:rgba(0,0,0,0.4);padding:4px 14px;border-radius:20px;
  pointer-events:none;transition:opacity 0.5s;white-space:nowrap;
}

/* â”€â”€ CONTROLS BAR â”€â”€ */
#controls{
  position:absolute;bottom:0;left:0;right:0;
  padding:14px 22px;
  background:linear-gradient(0deg,rgba(10,12,30,0.88) 0%,rgba(10,12,30,0) 100%);
  display:flex;justify-content:center;align-items:center;gap:10px;
  pointer-events:all;
}
.ctrl-btn{
  font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;
  letter-spacing:2px;padding:9px 20px;border:none;cursor:pointer;
  text-transform:uppercase;transition:all 0.18s;border-radius:2px;
  position:relative;overflow:hidden;
}
.ctrl-btn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,0);transition:background 0.18s;}
.ctrl-btn:hover::after{background:rgba(255,255,255,0.08);}

#btn-start{background:linear-gradient(135deg,#1155aa,#2288ee);color:#fff;box-shadow:0 2px 20px rgba(30,120,255,0.35);}
#btn-start:hover{box-shadow:0 4px 30px rgba(30,120,255,0.55);transform:translateY(-1px);}
#btn-reset{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.15);}
#btn-speed{background:rgba(255,210,0,0.1);color:#ffd700;border:1px solid rgba(255,210,0,0.3);}
#btn-editor{background:rgba(180,150,255,0.1);color:#cc99ff;border:1px solid rgba(180,150,255,0.25);}

/* divider in controls */
.ctrl-sep{width:1px;height:28px;background:rgba(255,255,255,0.1);margin:0 4px;}

/* â”€â”€ ARMY EDITOR PANEL â”€â”€ */
#editor-panel{
  display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(8,10,20,0.97);
  border:1px solid rgba(255,255,255,0.1);
  border-top:2px solid rgba(77,195,255,0.5);
  padding:28px 32px;width:440px;z-index:50;pointer-events:all;
  box-shadow:0 8px 60px rgba(0,50,200,0.25),0 0 0 1px rgba(255,255,255,0.04);
}
#editor-panel.open{display:block;}
.panel-title{font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:5px;color:#fff;margin-bottom:24px;display:flex;align-items:center;gap:10px;}
.panel-title::before{content:'';flex:1;height:1px;background:rgba(255,255,255,0.08);}
.panel-title::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.08);}

.sgrp{margin-bottom:18px;}
.sgrp > label{font-size:8px;letter-spacing:3px;color:rgba(255,255,255,0.4);display:block;margin-bottom:8px;text-transform:uppercase;}
.srow{display:flex;align-items:center;gap:14px;}
.srow input[type=range]{flex:1;-webkit-appearance:none;height:3px;border-radius:2px;background:rgba(255,255,255,0.15);outline:none;}
.srow input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#2288ee;cursor:pointer;box-shadow:0 0 8px rgba(34,136,238,0.6);}
.srow span{font-size:12px;color:#fff;min-width:32px;text-align:right;font-family:'Orbitron',sans-serif;}

.panel-sep{border:none;border-top:1px solid rgba(255,255,255,0.07);margin:20px 0;}

/* face upload */
.face-section-title{font-size:8px;letter-spacing:3px;color:rgba(255,255,255,0.4);margin-bottom:12px;text-transform:uppercase;}
.face-row{display:flex;gap:20px;}
.face-slot{display:flex;flex-direction:column;align-items:center;gap:8px;}
.face-thumb{
  width:64px;height:64px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.04);
  border-radius:3px;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  font-size:7px;color:rgba(255,255,255,0.25);
  letter-spacing:1px;cursor:pointer;position:relative;text-align:center;line-height:1.5;
  transition:border-color 0.2s;
}
.face-thumb:hover{border-color:rgba(255,255,255,0.3);}
.face-thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.face-thumb input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.face-tag{font-size:8px;letter-spacing:2px;font-family:'Orbitron',sans-serif;}
.face-tag.blue{color:#4dc3ff;}
.face-tag.red{color:#ff6644;}
.face-hint{font-size:8px;color:rgba(255,255,255,0.25);line-height:1.7;margin-top:10px;}
.face-hint code{background:rgba(255,255,255,0.06);padding:1px 5px;border-radius:2px;color:rgba(255,255,255,0.45);}

.panel-actions{display:flex;gap:10px;margin-top:24px;}
.pact-apply{
  background:linear-gradient(135deg,#1155aa,#2288ee);color:#fff;
  font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;
  padding:9px 22px;border:none;cursor:pointer;border-radius:2px;
  box-shadow:0 2px 16px rgba(30,120,255,0.3);transition:all 0.18s;
}
.pact-apply:hover{box-shadow:0 4px 24px rgba(30,120,255,0.5);}
.pact-close{
  background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.5);
  border:1px solid rgba(255,255,255,0.12);
  font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;
  padding:9px 22px;cursor:pointer;border-radius:2px;transition:all 0.18s;
}
.pact-close:hover{background:rgba(255,255,255,0.12);color:#fff;}

/* â”€â”€ VICTORY SCREEN â”€â”€ */
#victory{
  display:none;position:absolute;inset:0;
  background:rgba(5,8,20,0.82);
  align-items:center;justify-content:center;flex-direction:column;gap:16px;
  pointer-events:all;backdrop-filter:blur(4px);
}
#victory.show{display:flex;}
.v-winner{font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:6px;color:rgba(255,255,255,0.5);margin-bottom:-8px;}
#victory-title{font-family:'Orbitron',sans-serif;font-size:42px;font-weight:900;letter-spacing:6px;}
.v-sub{font-size:10px;letter-spacing:5px;color:rgba(255,255,255,0.35);}
.v-stats{display:flex;gap:32px;margin-top:8px;}
.v-stat{text-align:center;font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:2px;}
.v-stat strong{display:block;font-size:18px;color:#fff;font-family:'Orbitron',sans-serif;margin-bottom:2px;}
#btn-again{
  background:rgba(255,255,255,0.1);color:#fff;
  border:1px solid rgba(255,255,255,0.25);
  font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;
  padding:11px 28px;cursor:pointer;text-transform:uppercase;border-radius:2px;
  transition:all 0.2s;margin-top:6px;
}
#btn-again:hover{background:rgba(255,255,255,0.18);border-color:rgba(255,255,255,0.4);}

/* â”€â”€ CROSSHAIR â”€â”€ */
#xhair{
  display:none;position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);pointer-events:none;z-index:20;
}
#xhair.show{display:block;}
#xhair::before,#xhair::after{content:'';position:absolute;background:rgba(255,255,255,0.7);}
#xhair::before{width:16px;height:1px;top:0;left:-8px;}
#xhair::after{width:1px;height:16px;top:-8px;left:0;}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<!-- HUD -->
<div id="hud">
  <div id="title-bar">
    <!-- LEFT ARMY -->
    <div class="army-panel left">
      <div class="army-name"><span class="army-dot"></span>ALPHA BATTALION</div>
      <div class="stat-row">
        <span>ALIVE <span class="sv" id="blue-alive">0</span></span>
        <span>KILLS <span class="sv" id="blue-kills">0</span></span>
      </div>
      <div class="hbar-wrap"><div class="hbar" id="blue-health" style="width:100%"></div></div>
    </div>

    <!-- CENTER -->
    <div id="center-hud">
      <div id="game-title">CLONE WAR</div>
      <div id="phase-tag">STANDBY</div>
    </div>

    <!-- RIGHT ARMY -->
    <div class="army-panel right">
      <div class="army-name">OMEGA CORPS<span class="army-dot"></span></div>
      <div class="stat-row">
        <span>KILLS <span class="sv" id="red-kills">0</span></span>
        <span>ALIVE <span class="sv" id="red-alive">0</span></span>
      </div>
      <div class="hbar-wrap"><div class="hbar" id="red-health" style="width:100%"></div></div>
    </div>
  </div>

  <div id="cam-hint">ğŸ® CLICK TO ENTER SPECTATOR Â· WASD MOVE Â· QE UP/DOWN Â· SHIFT SPRINT Â· ESC EXIT</div>
  <div id="battle-log"></div>
  <div id="mini-stats">
    <div id="stat-time">00:00</div>
    <div id="stat-shots">0 SHOTS</div>
    <div id="stat-fps">â€” FPS</div>
  </div>
</div>

<div id="xhair"></div>

<!-- Army Editor -->
<div id="editor-panel">
  <div class="panel-title">ARMY EDITOR</div>

  <div class="sgrp">
    <label>â¬¡ Alpha Battalion â€” Troops</label>
    <div class="srow">
      <input type="range" id="blue-count" min="5" max="150" value="40" step="5">
      <span id="blue-count-val">40</span>
    </div>
  </div>

  <div class="sgrp">
    <label>â¬¡ Omega Corps â€” Troops</label>
    <div class="srow">
      <input type="range" id="red-count" min="5" max="150" value="40" step="5">
      <span id="red-count-val">40</span>
    </div>
  </div>

  <div class="sgrp">
    <label>HP per Soldier</label>
    <div class="srow">
      <input type="range" id="soldier-hp" min="1" max="12" value="3" step="1">
      <span id="soldier-hp-val">3</span>
    </div>
  </div>

  <hr class="panel-sep">

  <div class="face-section-title">Soldier Face Images</div>
  <div class="face-row">
    <div class="face-slot">
      <div class="face-thumb" id="fp-blue">
        <span>CLICK<br>TO UPLOAD</span>
        <input type="file" accept="image/*" id="fi-blue">
      </div>
      <div class="face-tag blue">ALPHA</div>
    </div>
    <div class="face-slot">
      <div class="face-thumb" id="fp-red">
        <span>CLICK<br>TO UPLOAD</span>
        <input type="file" accept="image/*" id="fi-red">
      </div>
      <div class="face-tag red">OMEGA</div>
    </div>
    <div style="flex:1;display:flex;align-items:flex-start;padding-top:4px;">
      <div class="face-hint">
        Upload any image â€” it will appear on each soldier's helmet.<br><br>
        <strong>Dev shortcut:</strong> set<br>
        <code>DEV_CONFIG.blueFaceUrl</code><br>
        in the JS to auto-load <code>image.png</code>.
      </div>
    </div>
  </div>

  <div class="panel-actions">
    <button class="pact-apply" id="btn-apply">âœ“ APPLY &amp; REDEPLOY</button>
    <button class="pact-close" id="btn-close-editor">CLOSE</button>
  </div>
</div>

<!-- Controls -->
<div id="controls">
  <button class="ctrl-btn" id="btn-reset">â†º RESET</button>
  <div class="ctrl-sep"></div>
  <button class="ctrl-btn" id="btn-start">â–¶ DEPLOY ARMIES</button>
  <div class="ctrl-sep"></div>
  <button class="ctrl-btn" id="btn-speed">SPEED Ã—1</button>
  <button class="ctrl-btn" id="btn-editor">âš™ ARMY EDITOR</button>
</div>

<!-- Victory -->
<div id="victory">
  <div class="v-winner">VICTORY</div>
  <div id="victory-title"></div>
  <div class="v-sub">BATTLE CONCLUDED</div>
  <div class="v-stats">
    <div class="v-stat"><strong id="v-blue-kills">0</strong>ALPHA KILLS</div>
    <div class="v-stat"><strong id="v-time">0:00</strong>DURATION</div>
    <div class="v-stat"><strong id="v-shots">0</strong>SHOTS FIRED</div>
    <div class="v-stat"><strong id="v-red-kills">0</strong>OMEGA KILLS</div>
  </div>
  <button id="btn-again">FIGHT AGAIN</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEVELOPER CONFIG â€” set URLs to auto-load face images
// e.g. blueFaceUrl: 'my_face.png'  (same folder as HTML)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEV_CONFIG = {
  blueFaceUrl: null,
  redFaceUrl:  null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CFG = { blueCount:40, redCount:40, hp:3 };
let scene, camera, renderer;
let soldiers=[], bullets=[], particles=[];
let running=false, gameSpeed=1;
let blueKills=0, redKills=0, totalShots=0;
let startTime=null, frameCount=0;
let fpsLast=performance.now(), fpsCount=0;
let blueFaceTex=null, redFaceTex=null;
let poolBlue=[], poolRed=[];

const S = {}; // shared geos & mats
const FIRE_RANGE=10, FIRE_CD=72, SPD=0.02, BSPD=0.30;
const MAX_B=140, MAX_P=50;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT THREE.JS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  scene = new THREE.Scene();

  // â”€â”€ DAYTIME SKY â”€â”€
  // Gradient sky via a large sphere with vertex colors
  scene.background = new THREE.Color(0x87ceeb);
  scene.fog = new THREE.Fog(0xc8e8f5, 55, 120);

  camera = new THREE.PerspectiveCamera(68, innerWidth/innerHeight, 0.1, 250);
  camera.position.set(0, 24, 38);
  camera.lookAt(0,0,0);

  renderer = new THREE.WebGLRenderer({
    canvas: document.getElementById('gameCanvas'),
    antialias: true,
  });
  renderer.setPixelRatio(Math.min(devicePixelRatio, 1.5));
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.1;

  // â”€â”€ DAYTIME LIGHTING â”€â”€
  // Bright sun from upper-right
  const sun = new THREE.DirectionalLight(0xfff5e0, 2.8);
  sun.position.set(30, 50, 20);
  sun.castShadow = true;
  sun.shadow.mapSize.width  = 2048;
  sun.shadow.mapSize.height = 2048;
  sun.shadow.camera.left   = -50;
  sun.shadow.camera.right  =  50;
  sun.shadow.camera.top    =  50;
  sun.shadow.camera.bottom = -50;
  sun.shadow.camera.far    = 150;
  sun.shadow.bias = -0.001;
  scene.add(sun);

  // Sky ambient â€” bright blue-white fill
  scene.add(new THREE.AmbientLight(0xb0d8ff, 1.4));

  // Hemisphere sky/ground
  scene.add(new THREE.HemisphereLight(0x87ceeb, 0x5a8a3a, 0.9));

  // Soft fill from opposite side
  const fill = new THREE.DirectionalLight(0xd0eeff, 0.6);
  fill.position.set(-20, 10, -10);
  scene.add(fill);

  buildSharedGeos();
  buildScene();

  if (DEV_CONFIG.blueFaceUrl) loadTexture(DEV_CONFIG.blueFaceUrl, 'blue');
  if (DEV_CONFIG.redFaceUrl)  loadTexture(DEV_CONFIG.redFaceUrl,  'red');

  window.addEventListener('resize', ()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });
}

function loadTexture(url, team) {
  new THREE.TextureLoader().load(url, tex=>{
    tex.flipY = false;
    if (team==='blue') blueFaceTex=tex; else redFaceTex=tex;
  });
}

function buildSharedGeos() {
  S.gBody   = new THREE.BoxGeometry(0.38, 0.50, 0.22);
  S.gHead   = new THREE.BoxGeometry(0.32, 0.30, 0.28);
  // Face plane â€” covers entire front face of head, no visor strip
  S.gFace   = new THREE.PlaneGeometry(0.30, 0.28);
  S.gLeg    = new THREE.BoxGeometry(0.14, 0.36, 0.14);
  S.gArm    = new THREE.BoxGeometry(0.11, 0.34, 0.11);
  S.gGun    = new THREE.BoxGeometry(0.05, 0.05, 0.38);
  S.gStripe = new THREE.BoxGeometry(0.39, 0.05, 0.23);
  S.gBullet = new THREE.BoxGeometry(0.07, 0.07, 0.24);
  S.gPart   = new THREE.BoxGeometry(0.09, 0.09, 0.09);
  S.gRock   = new THREE.DodecahedronGeometry(0.8, 0);
  S.gCone   = new THREE.ConeGeometry(6, 14, 5);
  S.gTree   = new THREE.ConeGeometry(1.0, 3.5, 6);
  S.gTrunk  = new THREE.CylinderGeometry(0.18, 0.22, 1.2, 5);

  S.mGun     = new THREE.MeshLambertMaterial({ color:0x1a1a1a });
  S.mDead    = new THREE.MeshLambertMaterial({ color:0x2a2a2a });
  S.mBulletB = new THREE.MeshBasicMaterial({ color:0x44ddff });
  S.mBulletR = new THREE.MeshBasicMaterial({ color:0xff5500 });
  S.mRock    = new THREE.MeshLambertMaterial({ color:0x7a7a68 });
  S.mMtn     = new THREE.MeshLambertMaterial({ color:0x4a5a40 });
  S.mTree    = new THREE.MeshLambertMaterial({ color:0x2d6e2d });
  S.mTrunk   = new THREE.MeshLambertMaterial({ color:0x7a5a30 });
  S.mPartB   = new THREE.MeshBasicMaterial({ color:0x22aaff, transparent:true });
  S.mPartR   = new THREE.MeshBasicMaterial({ color:0xff4400, transparent:true });
}

function buildScene() {
  // â”€â”€ GROUND â€” bright grass â”€â”€
  const groundGeo = new THREE.PlaneGeometry(130, 90, 1, 1);
  const groundMat = new THREE.MeshLambertMaterial({ color:0x5a8a3a });
  const ground = new THREE.Mesh(groundGeo, groundMat);
  ground.rotation.x = -Math.PI/2;
  ground.receiveShadow = true;
  scene.add(ground);

  // Dirt path in center
  const pathGeo = new THREE.PlaneGeometry(8, 90);
  const pathMat = new THREE.MeshLambertMaterial({ color:0xa08050 });
  const path = new THREE.Mesh(pathGeo, pathMat);
  path.rotation.x = -Math.PI/2;
  path.position.set(0, 0.01, 0);
  path.receiveShadow = true;
  scene.add(path);

  // Grid lines (subtle)
  const grid = new THREE.GridHelper(130, 65, 0x4a7a30, 0x4a7a30);
  grid.position.y = 0.02;
  scene.add(grid);

  // Center dividing line
  const lGeo = new THREE.BufferGeometry().setFromPoints([
    new THREE.Vector3(0,0.05,-44), new THREE.Vector3(0,0.05,44)
  ]);
  const lMat = new THREE.LineBasicMaterial({ color:0xffffff, transparent:true, opacity:0.2 });
  scene.add(new THREE.Line(lGeo, lMat));

  // Rocks
  const rockPos = [[-5,3],[5,-4],[0,0],[-9,7],[9,-7],[-4,-10],[4,10],[-13,1],[13,-1],[0,6],[0,-6],[-7,-2],[7,2]];
  rockPos.forEach(([x,z])=>{
    const r = new THREE.Mesh(S.gRock, S.mRock);
    r.position.set(x+(Math.random()-.5)*.6, 0.3, z+(Math.random()-.5)*.6);
    r.rotation.set(Math.random(), Math.random()*Math.PI, Math.random());
    r.scale.set(.4+Math.random()*.7, .3+Math.random()*.5, .4+Math.random()*.7);
    r.castShadow=true; r.receiveShadow=true;
    scene.add(r);
  });

  // Trees (cones + trunks)
  const treePts = [[-24,-8],[-26,4],[-28,-15],[-25,12],[24,8],[26,-4],[28,15],[25,-12],[22,0],[-22,0],[-24,20],[24,-20]];
  treePts.forEach(([x,z])=>{
    const h = 3+Math.random()*2;
    const tree = new THREE.Mesh(S.gTree, S.mTree);
    tree.position.set(x+(Math.random()-.5)*2, h/2+1.0, z+(Math.random()-.5)*2);
    tree.scale.set(.7+Math.random()*.6, (.7+Math.random()*.5)*(h/3.5), .7+Math.random()*.6);
    tree.castShadow=true;
    scene.add(tree);
    const trunk = new THREE.Mesh(S.gTrunk, S.mTrunk);
    trunk.position.set(tree.position.x, 0.6, tree.position.z);
    trunk.castShadow=true;
    scene.add(trunk);
  });

  // Mountains in far distance
  for (let i=0;i<14;i++) {
    const mt = new THREE.Mesh(S.gCone, S.mMtn);
    const side = i<7?1:-1;
    mt.position.set(-56+i%7*18, 7, side*48+Math.random()*5);
    mt.scale.set(.6+Math.random()*.9, .5+Math.random()*.8, .6+Math.random()*.9);
    scene.add(mt);
  }

  // Clouds (flat white discs far up)
  const cloudGeo = new THREE.SphereGeometry(1,6,4);
  const cloudMat = new THREE.MeshBasicMaterial({ color:0xffffff, transparent:true, opacity:0.85 });
  for (let i=0;i<8;i++) {
    const grp = new THREE.Group();
    for (let j=0;j<4;j++) {
      const c = new THREE.Mesh(cloudGeo, cloudMat);
      c.position.set((Math.random()-.5)*4, Math.random()*1, (Math.random()-.5)*2);
      c.scale.set(1.2+Math.random(), 0.55+Math.random()*.3, 1+Math.random());
      grp.add(c);
    }
    grp.position.set(-60+Math.random()*120, 38+Math.random()*12, -40+Math.random()*30);
    grp.scale.setScalar(2+Math.random()*2);
    scene.add(grp);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOLDIER MESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTeamMats(team) {
  const k = 'm_'+team;
  if (S[k]) return S[k];
  const blue = team==='blue';
  S[k] = {
    armor : new THREE.MeshLambertMaterial({ color: blue?0x1155cc:0xcc2200 }),
    detail: new THREE.MeshLambertMaterial({ color: blue?0x33aaff:0xff6600 }),
  };
  return S[k];
}

function makeSoldierMesh(team) {
  const g = new THREE.Group();
  const m = getTeamMats(team);
  const faceTex = team==='blue' ? blueFaceTex : redFaceTex;

  // Body
  const body = new THREE.Mesh(S.gBody, m.armor);
  body.position.y = 0.52;
  body.castShadow=true;
  g.add(body);

  // Chest stripe
  const stripe = new THREE.Mesh(S.gStripe, m.detail);
  stripe.position.set(0, 0.65, 0);
  g.add(stripe);

  // Head â€” plain armor color, no visor strip
  const head = new THREE.Mesh(S.gHead, m.armor);
  head.position.y = 0.97;
  head.castShadow=true;
  g.add(head);

  // Face: if texture uploaded â†’ show it full-face, else show a subtle screen glow
  if (faceTex) {
    // Full front-face texture â€” covers entire helmet face
    const fm = new THREE.MeshBasicMaterial({
      map: faceTex,
      transparent: true,
      depthWrite: false,
      polygonOffset: true,
      polygonOffsetFactor: -1,
    });
    const fp = new THREE.Mesh(S.gFace, fm);
    // Place flush with front face of head (depth 0.28/2 = 0.14 + tiny offset)
    fp.position.set(0, 0.97, 0.141);
    g.add(fp);
  } else {
    // Default: a glowing visor color block (no stripe on top)
    const blue = team==='blue';
    const visorMat = new THREE.MeshBasicMaterial({
      color: blue?0x44eeff:0xff5500,
    });
    // Just a thin emissive band across the lower half of the face
    const vGeo = new THREE.BoxGeometry(0.26, 0.10, 0.01);
    const visor = new THREE.Mesh(vGeo, visorMat);
    visor.position.set(0, 0.94, 0.141);
    g.add(visor);
  }

  // Legs
  [-0.09, 0.09].forEach(ox=>{
    const l = new THREE.Mesh(S.gLeg, m.armor);
    l.position.set(ox, 0.19, 0);
    l.castShadow=true;
    g.add(l);
  });

  // Arms
  [-0.26, 0.26].forEach(ox=>{
    const a = new THREE.Mesh(S.gArm, m.armor);
    a.position.set(ox, 0.52, 0);
    a.castShadow=true;
    g.add(a);
  });

  // Gun
  const gun = new THREE.Mesh(S.gGun, S.mGun);
  gun.position.set(0.24, 0.56, 0.22);
  g.add(gun);

  return g;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnArmies() {
  soldiers.forEach(s=>scene.remove(s.mesh));
  bullets.forEach(b=>scene.remove(b.mesh));
  particles.forEach(p=>scene.remove(p.mesh));
  soldiers=[]; bullets=[]; particles=[];
  poolBlue=[]; poolRed=[];
  blueKills=0; redKills=0; totalShots=0; frameCount=0;
  delete S.m_blue; delete S.m_red; // rebuild with fresh face textures

  spawnTeam('blue', CFG.blueCount);
  spawnTeam('red',  CFG.redCount);
  updateHUD();
}

function spawnTeam(team, count) {
  const cols = Math.ceil(Math.sqrt(count)*1.5);
  for (let i=0;i<count;i++) {
    const col=i%cols, row=Math.floor(i/cols);
    const xBase = team==='blue'?-20:20;
    const xDir  = team==='blue'?1:-1;
    const x = xBase+xDir*col*1.3+(Math.random()-.5)*.3;
    const z = -(Math.floor(count/cols)/2*1.3)+row*1.3+(Math.random()-.5)*.3;
    const mesh = makeSoldierMesh(team);
    mesh.position.set(x, 0, z);
    if (team==='red') mesh.rotation.y=Math.PI;
    scene.add(mesh);
    soldiers.push({
      mesh, team,
      hp:CFG.hp, maxHp:CFG.hp,
      alive:true,
      fireCooldown:Math.random()*FIRE_CD,
      bobOffset:Math.random()*Math.PI*2,
      target:null, searchCd:0,
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECTILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fireBullet(fromPos, toPos, team) {
  if (bullets.length>=MAX_B) return;
  const mesh = new THREE.Mesh(S.gBullet, team==='blue'?S.mBulletB:S.mBulletR);
  const origin = fromPos.clone().add(new THREE.Vector3(0,.62,0));
  mesh.position.copy(origin);
  const dir = toPos.clone().sub(fromPos).normalize();
  mesh.lookAt(mesh.position.clone().add(dir));
  scene.add(mesh);
  bullets.push({ mesh, dir, team, life:55, hit:false });
  totalShots++;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function boom(pos, team) {
  const n = Math.min(5, MAX_P-particles.length);
  const baseMat = team==='blue'?S.mPartB:S.mPartR;
  for (let i=0;i<n;i++) {
    const mesh = new THREE.Mesh(S.gPart, baseMat.clone());
    mesh.position.copy(pos).add(new THREE.Vector3(0,.7,0));
    scene.add(mesh);
    particles.push({
      mesh,
      vel:new THREE.Vector3((Math.random()-.5)*.13,Math.random()*.12+.04,(Math.random()-.5)*.13),
      life:20+Math.random()*14,
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BATTLE UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rebuildPools() {
  poolBlue=[]; poolRed=[];
  for(let i=0;i<soldiers.length;i++){
    const s=soldiers[i];
    if(s.alive){if(s.team==='blue')poolBlue.push(s);else poolRed.push(s);}
  }
}

function findNearest(s) {
  const pool = s.team==='blue'?poolRed:poolBlue;
  if(!pool.length) return null;
  let best=null, bd=1e9;
  const px=s.mesh.position.x, pz=s.mesh.position.z;
  for(let i=0;i<pool.length;i++){
    const e=pool[i];
    const dx=e.mesh.position.x-px, dz=e.mesh.position.z-pz;
    const d=dx*dx+dz*dz;
    if(d<bd){bd=d;best=e;}
  }
  return best?{enemy:best,dist:Math.sqrt(bd)}:null;
}

function updateSoldiers() {
  rebuildPools();
  for(let i=0;i<soldiers.length;i++){
    const s=soldiers[i]; if(!s.alive) continue;
    s.searchCd-=gameSpeed;
    if(s.searchCd<=0||!s.target||!s.target.alive){
      const r=findNearest(s); if(!r) continue;
      s.target=r.enemy; s.searchCd=10+Math.random()*8|0;
    }
    const en=s.target;
    const dx=en.mesh.position.x-s.mesh.position.x;
    const dz=en.mesh.position.z-s.mesh.position.z;
    const dist=Math.sqrt(dx*dx+dz*dz);

    s.mesh.rotation.y=Math.atan2(dx,dz);
    s.mesh.position.y=Math.sin(frameCount*.09+s.bobOffset)*.03;

    if(dist>FIRE_RANGE){
      const inv=SPD*gameSpeed/dist;
      s.mesh.position.x+=dx*inv; s.mesh.position.z+=dz*inv;
    } else {
      const sf=Math.sin(frameCount*.04+s.bobOffset)*SPD*.35*gameSpeed;
      s.mesh.position.x-=dz/dist*sf; s.mesh.position.z+=dx/dist*sf;
    }
    s.mesh.position.x=Math.max(-42,Math.min(42,s.mesh.position.x));
    s.mesh.position.z=Math.max(-32,Math.min(32,s.mesh.position.z));

    if(s.fireCooldown<=0&&dist<=FIRE_RANGE){
      fireBullet(s.mesh.position,en.mesh.position,s.team);
      s.fireCooldown=FIRE_CD+Math.random()*24;
    } else { s.fireCooldown-=gameSpeed; }
  }
}

function updateBullets() {
  const spd=BSPD*gameSpeed;
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    if(b.hit){scene.remove(b.mesh);bullets.splice(i,1);continue;}
    b.mesh.position.x+=b.dir.x*spd;
    b.mesh.position.y+=b.dir.y*spd;
    b.mesh.position.z+=b.dir.z*spd;
    b.life-=gameSpeed;
    const pool=b.team==='blue'?poolRed:poolBlue;
    const bx=b.mesh.position.x,bz=b.mesh.position.z;
    for(let j=0;j<pool.length;j++){
      const t=pool[j];
      const dx=t.mesh.position.x-bx,dz=t.mesh.position.z-bz;
      if(dx*dx+dz*dz<0.40){
        b.hit=true; t.hp--;
        boom(t.mesh.position,b.team);
        if(t.hp<=0)killSoldier(t,b.team);
        break;
      }
    }
    if(b.life<=0||b.hit){scene.remove(b.mesh);bullets.splice(i,1);}
  }
}

function updateParticles() {
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.mesh.position.add(p.vel);
    p.vel.y-=.007;
    p.life-=gameSpeed;
    p.mesh.material.opacity=Math.max(0,p.life/28);
    if(p.life<=0){scene.remove(p.mesh);particles.splice(i,1);}
  }
}

function killSoldier(s, killer) {
  s.alive=false;
  if(killer==='blue'){blueKills++;document.getElementById('blue-kills').textContent=blueKills;}
  else{redKills++;document.getElementById('red-kills').textContent=redKills;}
  s.mesh.rotation.z=Math.PI/2;
  s.mesh.position.y=-0.2;
  s.mesh.traverse(m=>{if(m.isMesh)m.material=S.mDead;});
  // Occasional log message (not every kill â€” too spammy)
  if(Math.random()<0.18) addLog(`${killer==='blue'?'Alpha':'Omega'} scored a kill`, killer);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD() {
  let ab=poolBlue.length, ar=poolRed.length;
  if(!running&&soldiers.length){
    ab=0;ar=0;
    for(let i=0;i<soldiers.length;i++){const s=soldiers[i];if(s.alive){if(s.team==='blue')ab++;else ar++;}}
  }
  document.getElementById('blue-alive').textContent=ab;
  document.getElementById('red-alive').textContent=ar;
  document.getElementById('blue-health').style.width=(ab/Math.max(1,CFG.blueCount)*100)+'%';
  document.getElementById('red-health').style.width=(ar/Math.max(1,CFG.redCount)*100)+'%';
  document.getElementById('stat-shots').textContent=totalShots+' SHOTS';

  if(startTime){
    const e=Math.floor((Date.now()-startTime)/1000);
    const mm=String(Math.floor(e/60)).padStart(2,'0'), ss=String(e%60).padStart(2,'0');
    document.getElementById('stat-time').textContent=`${mm}:${ss}`;
  }

  if(running&&(ab===0||ar===0)){
    running=false;
    const w=ab>0?'ALPHA BATTALION':ar>0?'OMEGA CORPS':'DRAW';
    const c=ab>0?'#4dc3ff':ar>0?'#ff6644':'#ffd700';
    document.getElementById('victory-title').textContent=w;
    document.getElementById('victory-title').style.color=c;
    // Victory stats
    const e=startTime?Math.floor((Date.now()-startTime)/1000):0;
    const mm=String(Math.floor(e/60)).padStart(2,'0'),ss=String(e%60).padStart(2,'0');
    document.getElementById('v-blue-kills').textContent=blueKills;
    document.getElementById('v-red-kills').textContent=redKills;
    document.getElementById('v-shots').textContent=totalShots;
    document.getElementById('v-time').textContent=`${mm}:${ss}`;
    document.getElementById('victory').classList.add('show');
    document.getElementById('phase-tag').textContent='BATTLE OVER';
    document.getElementById('btn-start').textContent='â–¶ DEPLOY ARMIES';
    addLog(w+' claims victory!','system');
  }
}

let _logThrottle=0;
function addLog(msg,type='system'){
  // Throttle to max 1 per 12 frames
  if(frameCount-_logThrottle<12&&type!=='system') return;
  _logThrottle=frameCount;
  const d=document.createElement('div');
  d.className='log-entry '+type; d.textContent=msg;
  const el=document.getElementById('battle-log');
  el.insertBefore(d,el.firstChild);
  while(el.children.length>6)el.removeChild(el.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPECTATOR CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pointerLocked=false;
let camYaw=-Math.PI/2, camPitch=-0.42;
let autoAngle=0;
const KEYS={};
const CAM_SPD=0.22;

function updateCamera() {
  if(pointerLocked){
    const spd=(KEYS.ShiftLeft||KEYS.ShiftRight)?CAM_SPD*3:CAM_SPD;
    const cosP=Math.cos(camPitch), sinP=Math.sin(camPitch);
    const sinY=Math.sin(camYaw), cosY=Math.cos(camYaw);
    const fwd=new THREE.Vector3(-sinY*cosP, sinP, -cosY*cosP);
    const right=new THREE.Vector3(cosY,0,-sinY);
    const up=new THREE.Vector3(0,1,0);
    if(KEYS.KeyW||KEYS.ArrowUp)    camera.position.addScaledVector(fwd,spd);
    if(KEYS.KeyS||KEYS.ArrowDown)  camera.position.addScaledVector(fwd,-spd);
    if(KEYS.KeyA||KEYS.ArrowLeft)  camera.position.addScaledVector(right,-spd);
    if(KEYS.KeyD||KEYS.ArrowRight) camera.position.addScaledVector(right,spd);
    if(KEYS.KeyE||KEYS.Space)      camera.position.addScaledVector(up,spd);
    if(KEYS.KeyQ)                  camera.position.addScaledVector(up,-spd);
    camera.rotation.order='YXZ';
    camera.rotation.y=camYaw;
    camera.rotation.x=camPitch;
  } else {
    autoAngle+=0.0004*gameSpeed;
    camera.position.x=Math.sin(autoAngle)*12;
    camera.position.z=36+Math.cos(autoAngle*.5)*5;
    camera.position.y=22+Math.sin(autoAngle*.65)*3;
    camera.lookAt(0,1,0);
  }
}

const cnv=document.getElementById('gameCanvas');
cnv.addEventListener('click',()=>{
  if(!document.getElementById('editor-panel').classList.contains('open'))
    cnv.requestPointerLock();
});
document.addEventListener('pointerlockchange',()=>{
  pointerLocked=document.pointerLockElement===cnv;
  document.getElementById('xhair').classList.toggle('show',pointerLocked);
  document.getElementById('cam-hint').style.opacity=pointerLocked?'0':'1';
  if(!pointerLocked) autoAngle=Math.atan2(camera.position.x,camera.position.z);
});
document.addEventListener('mousemove',e=>{
  if(!pointerLocked)return;
  camYaw-=e.movementX*.002;
  camPitch-=e.movementY*.002;
  camPitch=Math.max(-Math.PI/2+.03,Math.min(Math.PI/2-.03,camPitch));
});
document.addEventListener('keydown',e=>{
  KEYS[e.code]=true;
  if(e.code==='Escape'&&pointerLocked)document.exitPointerLock();
});
document.addEventListener('keyup',e=>KEYS[e.code]=false);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop() {
  requestAnimationFrame(loop);
  if(running){
    frameCount+=gameSpeed;
    updateSoldiers();
    updateBullets();
    updateParticles();
    if(frameCount%4===0) updateHUD();
  }
  updateCamera();
  renderer.render(scene,camera);
  // FPS
  fpsCount++;
  const now=performance.now();
  if(now-fpsLast>=1000){
    document.getElementById('stat-fps').textContent=fpsCount+' FPS';
    fpsCount=0; fpsLast=now;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-start').addEventListener('click',()=>{
  if(!running){
    document.getElementById('victory').classList.remove('show');
    if(!soldiers.length) spawnArmies();
    running=true; startTime=Date.now();
    document.getElementById('phase-tag').textContent='IN PROGRESS';
    document.getElementById('btn-start').textContent='â¸ PAUSE';
    addLog('Battle commences â€” armies advance!','system');
  } else {
    running=false;
    document.getElementById('phase-tag').textContent='PAUSED';
    document.getElementById('btn-start').textContent='â–¶ RESUME';
  }
});

function resetGame(){
  running=false;
  document.getElementById('victory').classList.remove('show');
  soldiers.forEach(s=>scene.remove(s.mesh));
  bullets.forEach(b=>scene.remove(b.mesh));
  particles.forEach(p=>scene.remove(p.mesh));
  soldiers=[];bullets=[];particles=[];poolBlue=[];poolRed=[];
  blueKills=0;redKills=0;totalShots=0;frameCount=0;startTime=null;
  ['blue-kills','red-kills','blue-alive','red-alive'].forEach(id=>document.getElementById(id).textContent=0);
  document.getElementById('blue-health').style.width='100%';
  document.getElementById('red-health').style.width='100%';
  document.getElementById('stat-time').textContent='00:00';
  document.getElementById('stat-shots').textContent='0 SHOTS';
  document.getElementById('phase-tag').textContent='STANDBY';
  document.getElementById('btn-start').textContent='â–¶ DEPLOY ARMIES';
  document.getElementById('battle-log').innerHTML='';
}
document.getElementById('btn-reset').addEventListener('click',resetGame);
document.getElementById('btn-again').addEventListener('click',resetGame);

const SPEEDS=[1,2,4,.5]; let sIdx=0;
document.getElementById('btn-speed').addEventListener('click',()=>{
  sIdx=(sIdx+1)%SPEEDS.length;
  gameSpeed=SPEEDS[sIdx];
  document.getElementById('btn-speed').textContent='SPEED Ã—'+gameSpeed;
});

// Editor panel
document.getElementById('btn-editor').addEventListener('click',()=>{
  document.getElementById('editor-panel').classList.toggle('open');
  if(pointerLocked)document.exitPointerLock();
});
document.getElementById('btn-close-editor').addEventListener('click',()=>{
  document.getElementById('editor-panel').classList.remove('open');
});
['blue-count','red-count','soldier-hp'].forEach(id=>{
  const el=document.getElementById(id);
  const vl=document.getElementById(id+'-val');
  el.addEventListener('input',()=>vl.textContent=el.value);
});
document.getElementById('btn-apply').addEventListener('click',()=>{
  CFG.blueCount=+document.getElementById('blue-count').value;
  CFG.redCount=+document.getElementById('red-count').value;
  CFG.hp=+document.getElementById('soldier-hp').value;
  document.getElementById('editor-panel').classList.remove('open');
  resetGame();
  addLog(`Alpha:${CFG.blueCount}  Omega:${CFG.redCount}  HP:${CFG.hp}`,'system');
});

// Face upload
function setupFaceInput(inputId, previewId, team){
  document.getElementById(inputId).addEventListener('change',e=>{
    const file=e.target.files[0]; if(!file)return;
    const url=URL.createObjectURL(file);
    const prev=document.getElementById(previewId);
    prev.innerHTML=`<img src="${url}"><input type="file" accept="image/*" id="${inputId}" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;">`;
    setupFaceInput(inputId,previewId,team);
    new THREE.TextureLoader().load(url,tex=>{
      tex.flipY=false;
      if(team==='blue')blueFaceTex=tex; else redFaceTex=tex;
      delete S['m_'+team];
      addLog(`${team==='blue'?'Alpha':'Omega'} face image ready!`,'good');
    });
  });
}
setupFaceInput('fi-blue','fp-blue','blue');
setupFaceInput('fi-red','fp-red','red');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
loop();
addLog('Systems online â€” click DEPLOY to begin.','system');
addLog('Click the battlefield to enter spectator mode.','system');
</script>
</body>
</html>
